# A makefile for building Google Test and using it in unit testing the PolySim
# project. Relies on object files generated by primary project makefile.
#
# 	make [all]	- makes everything.
# 	make TARGET - makes the given target.
# 	make clean	- removes all files generated by make.

CC = g++
CFLAGS = -g -Wall -Wextra -Wno-missing-field-initializers
INCS = -isystem $(GTEST_DIR)/include -I $(GTEST_DIR) -I ../src
LIBS =
OUT = ../bin/test.exe
SHELL = /bin/bash

GTEST_DIR = ../lib/gtest-1.7.0
GTEST_HEADERS = $(GTEST_DIR)/include/gtest/*.h \
								$(GTEST_DIR)/include/gtest/internal/*.h
GTEST_SRCS = $(GTEST_DIR)/src/*.cc $(GTEST_DIR)/src/*.h

TESTS = vector3d_test.o ivector3d_test.o random_test.o
OBJS = ../obj/util/vector3d.o ../obj/util/ivector3d.o ../obj/util/random.o

.PHONY: clean


all : gtest_main.a $(TESTS) $(OBJS)
	$(CC) $(CFLAGS) $(INCS) -lpthread $^ -o $(OUT)

vector3d_test.o : vector3d_test.cpp ../obj/util/vector3d.o $(GTEST_HEADERS)
	$(CC) $(CFLAGS) $(INCS) -c vector3d_test.cpp	

../obj/%.o : ../src/%.cpp
	make -C .. all

gtest-all.o : $(GTEST_SRCS) $(GTEST_HEADERS)
	$(CC) $(CFLAGS) $(INCS) -c $(GTEST_DIR)/src/gtest-all.cc

gtest_main.o : $(GTEST_SRCS) $(GTEST_HEADERS)
	$(CC) $(CFLAGS) $(INCS) -c $(GTEST_DIR)/src/gtest_main.cc

gtest.a : gtest-all.o
	$(AR) $(ARFLAGS) $@ $^

gtest_main.a : gtest-all.o gtest_main.o
	$(AR) $(ARFLAGS) $@ $^

clean :
	rm -f gtest.a gtest_main.a *.o $(OUT)

